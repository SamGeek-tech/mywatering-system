# Trigger on every push to master
trigger:
  - master


pool:
  vmImage: 'windows-latest'

variables:
  functionAppName: 'watering-system-func'      
  azureSubscription: 'MyServiceConnection'  # ←  ARM service connection name

stages:
- stage: Build
  displayName: 'Build & Publish'
  jobs:
  - job: BuildAndPublish
    displayName: 'Build .NET 9 Isolated Function'
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '9.0.x'

    - task: DotNetCoreCLI@2
      displayName: 'Restore'
      inputs:
        command: 'restore'
        projects: '**/*.csproj'

    - task: DotNetCoreCLI@2
      displayName: 'Build'
      inputs:
        command: 'build'
        projects: '**/*.csproj'
        arguments: '--configuration Release --no-restore'

    - task: DotNetCoreCLI@2
      displayName: 'Publish'
      inputs:
        command: 'publish'
        publishWebProjects: false
        projects: '**/*FunctionApp.csproj'   # ← change if your project name differs
        arguments: '--configuration Release --output $(Build.ArtifactStagingDirectory)/app --no-build'
        zipAfterPublish: true

    - task: PublishBuildArtifacts@1
      displayName: 'Upload package'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'

# PRODUCTION DEPLOYMENT
- stage: Deploy_Production
  displayName: 'Deploy to Production'
  condition: succeeded()
  jobs:
  - deployment: Deploy
    displayName: 'Deploy to Azure Function App'
    environment: prod                     # ← you already created this
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - task: AzureFunctionApp@1
            displayName: 'Deploy to Production'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: 'functionApp'
              appName: '$(functionAppName)'           # e.g. watering-system-func
              package: '$(Pipeline.Workspace)/drop/app/*.zip'
              deploymentMethod: 'zipDeploy'
              # NO appSettings → everything comes from Key Vault references already configured in the portal!